* Update t2

** Without the jacobian
Update:
$$t_i^a \leftarrow t_i^a - \frac{r_i^a}{2fcc_a^a - 2fcc_i^i}$$

#+BEGIN_SRC f90 :comments org :tangle update_t2.irp.f
subroutine update_amplitudes_pccd(nO, nV, r2, t2)
  
  implicit none

  BEGIN_DOC
  ! Standard update of the pCCD amplitudes
  END_DOC

  ! in
  integer, intent(in)           :: nO, nV
  double precision, intent(in)  :: r2(nO, nV)

  ! out
  double precision, intent(out) :: t2(nO, nV)

  ! internal
  integer                       :: i, a

  ! New amplitudes
  do a = 1, nV
    do i = 1, nO
      t2(i,a) = t2(i,a) - r2(i,a)/(2d0 * cc_space_f_v(a) - 2d0 * cc_space_f_o(i))
    enddo
  enddo

end  
#+END_SRC

** With the jacobian

Update of the amplitudes:
$$ t_i^a \leftarrow t_i^a - \sum_{jb} (J^{-1})_{ia,jb} r_j^b$$

#+BEGIN_SRC f90 :comments org :tangle update_t2.irp.f
subroutine update_amplitudes_pccd_w_J(nO, nV, r2, inv_t2_jacobian, t2)
  
  implicit none

  BEGIN_DOC
  ! Update of the pCCD amplitudes with the jacobian matrix
  END_DOC

  ! in
  integer, intent(in)           :: nO, nV
  double precision, intent(in)  :: r2(nO, nV)
  double precision, intent(in)  :: inv_t2_jacobian(nO, nV,nO, nV)

  ! out
  double precision, intent(out) :: t2(nO, nV)

  ! internal
  integer                       :: i,a,j,b

  ! New amplitudes
  do b = 1, nV
    do j = 1, nO
      do a = 1, nV
        do i = 1, nO
          t2(i,a) = t2(i,a) - inv_t2_jacobian(i,a,j,b) * r2(j,b)
        enddo
      enddo
    enddo
  enddo

end  
#+END_SRC
